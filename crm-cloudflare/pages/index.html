<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CRM on Cloudflare</title>
    <script>
      (() => {
        const applyThemeVars = (theme) => {
          if (!theme) return;
          const root = document.documentElement;
          if (theme.bg) root.style.setProperty('--bg', theme.bg);
          if (theme.panel) root.style.setProperty('--panel', theme.panel);
          if (theme.ink) root.style.setProperty('--ink', theme.ink);
          if (theme.muted) root.style.setProperty('--muted', theme.muted);
          if (theme.line) root.style.setProperty('--line', theme.line);
          if (theme.accent) root.style.setProperty('--accent', theme.accent);
          if (theme.accentSoft) root.style.setProperty('--accent-soft', theme.accentSoft);
          if (theme.danger) root.style.setProperty('--danger', theme.danger);
        };
        try {
          const raw = localStorage.getItem('crm_theme_v1');
          if (raw) {
            applyThemeVars(JSON.parse(raw));
          }
        } catch {}
        fetch('https://crm-api.gdeharo.workers.dev/api/settings/theme')
          .then((res) => (res.ok ? res.json() : null))
          .then((data) => {
            if (!data?.theme) return;
            applyThemeVars(data.theme);
            try {
              localStorage.setItem('crm_theme_v1', JSON.stringify(data.theme));
            } catch {}
          })
          .catch(() => {});
      })();
    </script>
    <link rel="stylesheet" href="./styles.css" />
  </head>
  <body>
    <header class="topbar">
      <div>
        <h1 id="pageTitle">Company list</h1>
        <p id="pageHint" class="hidden">Company list</p>
      </div>
      <div class="top-actions">
        <button id="backBtn" class="ghost hidden" type="button">Back</button>
        <button id="manageRepsBtn" class="hidden" type="button">Admin Panel</button>
        <span id="whoami" class="whoami hidden"></span>
        <button id="logoutBtn" class="hidden" type="button">Log out</button>
      </div>
    </header>

    <main>
      <section id="authView" class="panel">
        <h2>Access</h2>
        <div class="split">
          <form id="bootstrapForm" class="card hidden">
            <h3>Initial Admin Setup</h3>
            <label><span class="sr-only">Email</span><input name="email" type="email" placeholder="Email" aria-label="Email" required /></label>
            <label><span class="sr-only">Full name</span><input name="fullName" placeholder="Full name" aria-label="Full name" required /></label>
            <label><span class="sr-only">Password</span><input name="password" type="password" placeholder="Password" aria-label="Password" required /></label>
            <button type="submit">Create first admin</button>
          </form>

          <form id="loginForm" class="card">
            <h3>Log in</h3>
            <label><span class="sr-only">Email</span><input name="email" type="email" placeholder="Email" aria-label="Email" required /></label>
            <label><span class="sr-only">Password</span><input name="password" type="password" placeholder="Password" aria-label="Password" required /></label>
            <button type="submit">Sign in</button>
          </form>

          <form id="inviteSetupForm" class="card hidden">
            <h3>Set Your Password</h3>
            <label><span class="sr-only">Email</span><input name="email" type="email" placeholder="Email" aria-label="Email" disabled /></label>
            <label><span class="sr-only">New password</span><input name="password" type="password" placeholder="New password" aria-label="New password" required /></label>
            <label><span class="sr-only">Confirm password</span><input name="confirmPassword" type="password" placeholder="Confirm password" aria-label="Confirm password" required /></label>
            <button type="submit">Save Password</button>
          </form>
        </div>
      </section>

      <section id="companyListView" class="panel hidden">
        <div class="row between">
          <h2>Companies</h2>
          <button id="showCreateCompanyBtn" type="button">Add Company</button>
        </div>
        <div class="row">
          <input id="companySearch" class="search" placeholder="Search by company, city, or state" />
        </div>
        <div id="noCompanyMatch" class="empty hidden">
          <p>No matching companies found.</p>
          <button id="quickAddCompanyBtn" type="button">Add New Company</button>
        </div>

        <form id="createCompanyForm" class="card hidden form-grid">
          <h3>New Company</h3>
          <label><span class="sr-only">Name</span><input name="name" placeholder="Name" aria-label="Name" required /></label>
          <label><span class="sr-only">Main phone</span><input name="mainPhone" placeholder="Main phone" aria-label="Main phone" /></label>
          <label class="full"><span class="sr-only">Street</span><textarea name="address" rows="1" class="street-field" placeholder="Street" aria-label="Street"></textarea></label>
          <label><span class="sr-only">City</span><input name="city" placeholder="City" aria-label="City" /></label>
          <div class="address-row full">
            <label id="createCompanyStateWrap"><span class="sr-only">State/Province</span><input name="state" placeholder="State/Province" aria-label="State/Province" /></label>
            <label><span class="sr-only">Postal Code</span><input name="zip" placeholder="Postal Code" aria-label="Postal Code" /></label>
          </div>
          <label><span class="sr-only">Country</span><select name="country" id="createCompanyCountry" aria-label="Country"></select></label>
          <label><span class="sr-only">URL</span><input name="url" type="url" placeholder="URL" aria-label="URL" /></label>
          <label><span class="sr-only">Segment</span><select name="segment" id="createCompanySegment" aria-label="Segment"></select></label>
          <label><span class="sr-only">Type</span><select name="customerType" id="createCompanyType" aria-label="Type"></select></label>
          <label class="full"><span class="sr-only">Notes</span><textarea name="notes" placeholder="Notes" aria-label="Notes"></textarea></label>
          <div class="row wrap full">
            <button type="submit">Create</button>
            <button id="cancelCreateCompanyBtn" type="button" class="ghost">Cancel</button>
          </div>
        </form>

        <table>
          <thead>
            <tr>
              <th>Company</th>
              <th>City</th>
              <th>State</th>
            </tr>
          </thead>
          <tbody id="companiesBody"></tbody>
        </table>
      </section>

      <section id="companyDetailView" class="hidden">
        <details id="companyMainSection" class="panel">
          <summary>Company Information</summary>
          <form id="companyEditForm" class="form-grid"></form>
        </details>

        <details id="companyContactsSection" class="panel">
          <summary>Contacts</summary>
          <div class="row between">
            <p class="muted">Click a contact row to open details.</p>
            <button id="newContactBtn" type="button">New Contact</button>
          </div>
          <table>
            <thead>
              <tr>
                <th>Name</th>
                <th>Email</th>
                <th>Phone</th>
              </tr>
            </thead>
            <tbody id="contactsBody"></tbody>
          </table>
        </details>

        <details id="companyInteractionsSection" class="panel">
          <summary>Interactions (Newest First)</summary>
          <div class="row between">
            <p class="muted">Click an interaction row to open details.</p>
            <button id="newInteractionBtn" type="button">New Interaction</button>
          </div>
          <table>
            <thead>
              <tr>
                <th>Date</th>
                <th>Editor</th>
                <th>Type</th>
                <th>Notes</th>
                <th>Next action</th>
              </tr>
            </thead>
            <tbody id="interactionsBody"></tbody>
          </table>
        </details>
      </section>

      <section id="contactDetailView" class="panel hidden">
        <h2 class="hidden">Contact Detail</h2>
        <form id="contactEditForm" class="form-grid"></form>
      </section>

      <section id="contactCreateView" class="panel hidden">
        <h2 class="hidden">New Contact</h2>
        <form id="contactCreateForm" class="form-grid"></form>
      </section>

      <section id="interactionDetailView" class="panel hidden">
        <h2>Interaction Detail</h2>
        <form id="interactionEditForm" class="form-grid"></form>
      </section>

      <section id="interactionCreateView" class="panel hidden">
        <h2>New Interaction</h2>
        <form id="interactionCreateForm" class="form-grid"></form>
      </section>

      <section id="repsView" class="panel hidden">
        <div class="row between">
          <h2>Admin Control Panel</h2>
        </div>

        <details class="admin-section">
          <summary>Theme</summary>
          <div class="card">
            <form id="themeForm" class="row wrap"></form>
          </div>
        </details>

        <details class="admin-section">
          <summary>Meeting Types</summary>
          <div class="card">
            <form id="interactionTypeValueForm" class="row wrap"></form>
            <ul id="interactionTypeList" class="list"></ul>
          </div>
        </details>

        <details class="admin-section">
          <summary>Reps</summary>
          <div class="card">
            <form id="repCreateForm" class="row wrap"></form>
            <form id="repAssignmentForm" class="row wrap"></form>
            <table>
              <thead>
                <tr>
                  <th>Rep</th>
                  <th>Email</th>
                  <th>Phone</th>
                  <th>Last Entry</th>
                  <th>Assigned companies</th>
                  <th>Territories</th>
                </tr>
              </thead>
              <tbody id="repsBody"></tbody>
            </table>
          </div>
        </details>

        <details class="admin-section">
          <summary>Territories</summary>
          <div class="card">
            <form id="territoryForm" class="row wrap"></form>
            <ul id="territoryList" class="list"></ul>
          </div>
        </details>

        <details class="admin-section">
          <summary>Dropdown Values</summary>
          <div class="card">
            <div class="value-columns">
              <div>
                <h3>Segments</h3>
                <form id="segmentValueForm" class="row wrap"></form>
                <ul id="segmentValueList" class="list"></ul>
              </div>
              <div>
                <h3>Types</h3>
                <form id="typeValueForm" class="row wrap"></form>
                <ul id="typeValueList" class="list"></ul>
              </div>
            </div>
          </div>
        </details>

        <details id="userAdminCard" class="admin-section hidden">
          <summary>Users</summary>
          <div class="card">
            <form id="userCreateForm" class="row wrap"></form>
            <table>
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Email</th>
                  <th>Role</th>
                  <th>Last Login</th>
                  <th>
                    <span class="row wrap">
                      Active
                      <label class="user-filter-toggle">
                        <input id="showInactiveUsersToggle" type="checkbox" />
                      </label>
                    </span>
                  </th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="usersBody"></tbody>
            </table>
          </div>
        </details>
      </section>

      <section id="repAccountsView" class="panel hidden">
        <h2 id="repAccountsTitle">Rep Accounts</h2>
        <div class="card">
          <h3>Assigned Territory Rules</h3>
          <ul id="repTerritorySummary" class="list compact-list"></ul>
        </div>
        <table>
          <thead>
            <tr>
              <th>Company</th>
              <th>City</th>
              <th>State</th>
              <th>Zip</th>
            </tr>
          </thead>
          <tbody id="repAccountsBody"></tbody>
        </table>
      </section>
    </main>

    <aside id="toast" class="toast hidden"></aside>

    <script>
      window.CRM_API_BASE = "https://crm-api.gdeharo.workers.dev";
    </script>
    <script src="./app.js" defer></script>
  </body>
</html>
